# 17. 工作区重构与预览优化

## 1. 功能概述
本次更新主要聚焦于**IDE 工作区布局的重构**以及**代码预览体验的优化**。我们引入了全新的"双模式"工作区，将任务编排（Planning）与代码编辑（Editing）分离，同时解决了预览环境中的交互干扰问题。

## 2. 核心变更

### 2.1 双模式工作区 (Dual-Mode Workspace)
为了更好地支持 AI 辅助开发流程，我们将右侧面板重构为独立的 `WorkspacePanel`，支持两种模式切换：

- **编排模式 (Planning Mode)**:
    - 采用泳道图 (Swimlane) 可视化展示 AI Agent 的执行状态。
    - 实时同步 AI 思考过程与子任务进度。
- **编辑模式 (Editing Mode)**:
    - 集成全功能代码编辑器 (Streaming Editor)。
    - 左侧新增文件资源管理器 (File Tree Sidebar)，支持递归目录浏览。
    - 支持多标签页 (Tabs) 管理打开的文件。
    - 编辑器支持“幽灵光标”效果，实时展示 AI 编写代码的过程。

### 2.2 预览环境优化
针对 Sandpack 预览环境进行了多项体感优化：

- **屏蔽自动打印**: 修复了某些页面加载时自动触发 `window.print()` 导致弹出打印窗口的问题。我们通过劫持 `preview` 环境中的 `window.print` 方法实现了静默处理。
- **非 React 代码检测**: 增加了智能启发式检测机制。当 AI 生成 Python 脚本或其他非 React/HTML 代码时，预览窗口将不再尝试渲染（导致白屏或报错），而是友好地显示“无法预览此类代码”的提示及原始内容。

### 2.3 状态管理重构
引入了 `WorkspaceContext` 全局状态管理：
- 统一管理 `mode` (模式)、`activeFile` (当前文件)、`fileTree` (文件树) 等状态。
- 实现了与后端 AI 日志的实时同步，自动更新 Agent 状态和文件列表。

## 3. 技术细节
- **组件重构**: `ChatPageClient` 不再直接处理复杂的 UI 逻辑，而是作为 `WorkspaceProvider` 的容器，将具体实现下沉至 `WorkspacePanel`。
- **Sandpack 定制**: 通过注入自定义的 `/index.js` 入口文件，在 React 应用挂载前预先执行环境补丁。

## 4. 截图
*(此处可并在实际文档中补充 UI 截图)*
