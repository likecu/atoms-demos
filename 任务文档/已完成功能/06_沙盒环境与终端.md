# 06. 沙盒环境与终端功能

> 📅 完成时间: 2026-02-07
> 🎯 目标: 为每个用户提供独立、隔离的执行环境（Sandbox），支持文件系统操作和 Shell 命令执行。

## 1. 核心架构：Docker Sibling 模式

为了在从单体 VPS 上安全地隔离用户环境，我们采用了 **Docker Sibling (Docker-on-Host)** 方案：

*   **原理**: 主应用容器挂载宿主机的 `/var/run/docker.sock`，通过调用宿主机的 Docker Daemon 来启动和管理其他的“兄弟”容器。
*   **隔离性**: 每个用户分配一个独立的轻量级容器（基于 `node:20-alpine` 构建的 `atoms-sandbox`）。
*   **持久化**: 宿主机的 `/home/milk/atoms-data/workspaces/{userId}` 目录被挂载到沙盒容器内的 `/workspace`，保证数据持久化且易于备份。

## 2. 功能实现

### 2.1 后端实现 (`src/lib/sandbox/`)

*   **Sandbox 管理器 (`manager.ts`)**: 单例模式，负责：
    *   `initWorkspace(userId)`: 在宿主机创建用户专属目录。
    *   `getOrCreateSandbox(userId)`: 启动或复用现有的 Docker 容器，配置内存限制 (512MB) 和 CPU 限制 (0.5核)。
    *   `execCommand(userId, command)`: 通过 Docker API 执行 `exec` 命令，并捕获 `stdout`/`stderr`。
*   **配置 (`config.ts`)**:
    *   定义镜像名称: `atoms-sandbox:latest`
    *   定义资源限制策略。
    *   支持开发环境 (Mac Local) 和生产环境 (Docker Host) 的路径自动切换。
*   **Server Actions (`actions/sandbox.ts`)**:
    *   暴露 `execSandboxCommand` 给前端，包含权限校验 (Auth Guard)。

### 2.2 前端实现 (`src/components/sandbox/`)

*   **终端界面 (`terminal-panel.tsx`)**:
    *   模拟真实的 Terminal 体验 (黑色背景、等宽字体)。
    *   支持输入命令并回显执行结果。
    *   处理加载状态和错误反馈。
*   **布局集成 (`chat-page-client.tsx`)**:
    *   改造了右侧面板，增加了 **Tab 切换功能**。
    *   支持在 "预览 (Preview)" 和 "终端 (Terminal)" 之间无缝切换。

### 2.3 自定义镜像

为了支持更多开发工具，我们在 `src/lib/sandbox/Dockerfile` 中构建了自定义镜像：
```dockerfile
FROM node:20-alpine
RUN apk add --no-cache bash git curl python3 make g++
WORKDIR /workspace
CMD ["tail", "-f", "/dev/null"]
```

## 3. 部署配置

### 3.1 环境变量配置
在 `.env.local` 或生产环境 `.env` 中添加：
```bash
# 宿主机上存储用户工作区的绝对路径
SANDBOX_HOST_DIR=/home/milk/atoms-data/workspaces
```

### 3.2 权限配置
主应用容器 (`atoms-demo`) 必须挂载 Docker Socket：
```yaml
volumes:
  - /var/run/docker.sock:/var/run/docker.sock
  - /home/milk/atoms-data/workspaces:/app/workspaces
```

## 4. 验证方式

1.  登录应用，进入任意聊天项目。
2.  点击右侧面板顶部的 **"终端"** 标签。
3.  输入 `ls -la`，应看到 `/workspace` 目录下的内容。
4.  输入 `echo "hello" > test.txt`，文件应被创建并持久化。
