# 18. 沙盒稳定性与生命周期管理

## 1. 概述
为了提升系统的稳定性并在高负载下保持服务的可用性，我们对沙盒模块 `SandboxManager` 进行了深度优化。本次更新主要包含**自动生命周期管理**与**输出截断保护**两大核心机制。

## 2. 核心功能

### 2.1 自动生命周期管理 (Idle Cleanup)
为了优化服务器资源利用，系统能够自动监控用户的沙盒活动，并在用户长时间（目前设定为 2 小时）不活跃时自动关闭并清理沙盒容器。

- **活跃度追踪**:
  - 系统在内存中维护 `lastActivity` Map，记录每个用户的最后操作时间。
  - 任何沙盒操作（执行命令、读写文件）都会刷新用户的活跃时间戳。

- **自动清理**:
  - **检查频率**: 每 5 分钟执行一次后台检查。
  - **超时阈值**: 2 小时无操作。
  - **清理动作**: 停止并移除 Docker 容器，释放内存与 CPU 资源。

- **自动恢复**:
  - 当用户再次发起请求时，系统会自动检测并重建容器。
  - 用户的 `/workspace` 目录挂载在宿主机上，容器重建仅重置运行环境，文件数据仅久保存。

### 2.2 输出截断保护 (Output Truncation)
修复了因命令产生大量输出导致 Node.js 进程崩溃的 `RangeError: Invalid string length` 问题。

- **问题背景**: 
  - 之前的实现将所有 `stdout` 和 `stderr` 数据无限制地拼接在内存字符串中。
  - 当进程（如无限循环打印或大数据转储）产生超过 V8 引擎字符串长度限制的数据时，会导致整个应用服务崩溃。

- **解决方案**:
  - 引入 `MAX_OUTPUT_SIZE` 常量 (默认 1MB)。
  - 在流式接收 Docker 输出时，实时检测累积长度。
  - 一旦超过限制，自动截断后续输出，并追加 `[... Output truncated due to size limit ...]` 提示信息。

## 3. 技术实现

### 代码位置
`src/lib/sandbox/manager.ts`

### 关键配置
```typescript
// 资源清理配置
private readonly IDLE_TIMEOUT = 2 * 60 * 60 * 1000; // 2小时
private readonly CHECK_INTERVAL = 5 * 60 * 1000;    // 5分钟

// 输出保护配置
const MAX_OUTPUT_SIZE = 1024 * 1024; // 1MB Limit
```

## 4. 优势
1.  **高可用性**: 防止单个用户的恶意或错误操作导致整个服务崩溃。
2.  **资源优化**: 自动回收闲置资源，降低服务器成本。
3.  **用户体验**: 自动恢复机制对用户透明，兼顾了体验与成本。
