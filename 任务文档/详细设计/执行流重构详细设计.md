# 执行流重构详细设计文档 (Detailed Design: Execution Flow Refactor)

## 1. 背景与目标
原有的 `AIStatusPanel` 仅支持线性的日志展示，无法有效表达 Agentic Workflow 中复杂的父子调用关系和并行执行逻辑。为了提升系统的可观测性，我们需要重构前端渲染逻辑。

**核心目标**:
1. **层级可视化**: 清晰区分主代理和子代理。
2. **并行表达**: 直观展示同时运行的多个子代理。
3. **交互增强**: 支持折叠、详情查看。

## 2. 数据结构设计

### 2.1 后端数据模型 (现有)
Supabase 中的 `ai_call_logs` 表已经包含了 `parent_log_id` 字段，这为树形结构提供了基础。
- `id`: UUID
- `parent_log_id`: UUID (指向父级日志或 Tool Call)
- `step_type`: 'thinking' | 'tool_call' | 'tool_result' | 'output'
- `metadata`: JSON (包含 `toolCallId`, `toolName`, `args` 等)

### 2.2 前端视图模型 (Tree Node)
我们需要将扁平的 `AICallLog[]` 转换为 `LogNode[]` 树。

```typescript
type LogNode = AICallLog & {
    children: LogNode[];
    depth: number;
    isSubAgentDispatch?: boolean; // 标记是否为子代理调度的起始节点
}
```

### 2.3 转换算法 (`buildLogTree`)
1. **初始化**: 将所有 Logs 映射为 Nodes。
2. **建立索引**: 创建 `id -> node` 和 `toolCallId -> node` 的映射。
3. **构建树**:
    - 遍历所有 Logs。
    - 如果 Log 有 `parent_log_id`，尝试找到父节点。
    - 特殊处理：`dispatch_subagent` 的内部日志通常将 `dispatch` 的 `toolCallId` 作为父 ID。
    - 将 Node 挂载到 Parent.children。
    - 若无 Parent，则挂载到 Root。

## 3. UI 组件架构

### 3.1 组件树
```
ExecutionFlow (Main Container)
├── NodeList (Recursive List Renderer)
│   ├── LogItem (Standard Layout for Thought/Tool)
│   └── SubAgentGrid (Container for Parallel Agents)
│       ├── AgentCard (Sub-agent A)
│       │   └── NodeList (Recursive...)
│       └── AgentCard (Sub-agent B)
│           └── NodeList (Recursive...)
└── LogDetailPanel (Sidebar)
```

### 3.2 关键组件逻辑

#### `NodeList`
负责遍历节点列表，并识别**连续的** `isSubAgentDispatch` 节点。
- 如果遇到普通节点 -> 直接渲染 `LogItem`。
- 如果遇到 `dispatch` 节点 -> 缓存到临时数组 `currentParallelGroup`。
- 如果遇到非 `dispatch` 节点且缓存非空 -> 渲染 `SubAgentGrid` (将缓存的节点一次性传入)，然后清空缓存，再渲染当前节点。
- 循环结束 -> 渲染剩余缓存的 `SubAgentGrid`。

#### `SubAgentGrid`
- 接收 `LogNode[]` 作为 props。
- 如果节点数 > 1，使用 `grid-cols-2` (或 flex wrap) 布局。
- 如果节点数 = 1，使用 `grid-cols-1`。

#### `AgentCard`
- 独立的 UI 容器，带有边框和背景色。
- Header: 展示 Agent Role (从 metadata.args 解析) 和 状态。
- Body: 包含一个递归的 `NodeList`。
- 状态判断:
    - Running: 无 Error 且无最终 Result。
    - Completed: 包含 `tool_result` 类型的子节点（对应 dispatch 的返回值）。
    - Error: 包含 error 标记。

## 4. 样式系统 (Tailwind CSS)
- **配色**:
    - Main Agent: 默认 Zinc 色系。
    - Sub Agent: Purple/Indigo 色系，区分度高。
    - Success: Emerald 色系。
    - Error: Red 色系。
- **动效**:
    - 使用 `framer-motion` 处理展开/折叠动画 (`AnimatePresence`).
    - 侧边栏滑出动画。

## 5. 局限性与未来规划
- **深度限制**:目前的 UI 在移动端或极深层级（>4层）可能显示拥挤。虽然后端限制了 Depth=3，但 UI 应考虑横向滚动优化。
- **实时性**: 依赖前端轮询或 Supabase Realtime 更新 Logs。当前实现假设 Logs 是全量获取的。
