# 智能 Agent 工作区 v2.0 详细设计文档

## 1. 概述 (Executive Summary)
本项目旨在构建一个"分屏" IDE 风格的交互界面，实现左侧用户对话、右侧 Agent 执行复杂任务的协同工作流。核心升级在于右侧面板支持**实时可视化追踪**，能够根据任务上下文在"编排模式"（多 Agent 协作）和"编辑模式"（代码编写/文档生成）之间无缝切换。

## 2. 核心功能 (Core Features)

### 2.1 双面板架构 (Dual-Pane Architecture)
*   **左侧面板 (Chat Stream)**: 负责用户指令输入、高层级状态反馈及简单的对话交互。
*   **右侧面板 (Dynamic Workspace)**: 一个上下文感知的动态画布，根据 Agent 的当前活动自动切换视图。

### 2.2 多模式工作区 (Multi-Mode Workspace)
*   **模式 A: 编排模式 (Orchestration Mode)**
    *   **触发场景**: 任务规划阶段、多 Agent 协作阶段。
    *   **核心视图**: 泳道图 (Swimlanes)、任务卡片 (Task Cards)。
    *   **视觉反馈**: 脉冲效果表示"进行中"，灰置表示"待处理"，绿勾表示"已完成"。
*   **模式 B: 编辑模式 (Editor Mode)**
    *   **触发场景**: 编写代码、生成文件、修改文档。
    *   **核心视图**: 文件资源管理器 (左侧树状图)、代码编辑器 (右侧画布)、多标签页系统。

### 2.3 实时焦点追踪 (Real-Time Focus Tracking)
*   **幽灵光标 (Ghost Cursor)**: 在编辑器中实时渲染 Agent 的输入光标，带有 Agent 名称/颜色标识。
*   **流式打字机效果 (Streaming Typewriter)**: 模拟人类输入过程，而非瞬间生成，提升可感知性。
*   **自动跟随 (Auto-Scroll)**: 视口自动滚动以保持光标在可视区域内。

## 3. 技术架构 (Technical Architecture)

### 3.1 状态管理 (State Management)
引入 `WorkspaceContext` (基于 React Context 或 Zustand) 来管理右侧面板的复杂状态，与全局 `AppContext` 分离。

```typescript
interface WorkspaceState {
  // 当前工作区模式
  mode: 'PLANNING' | 'EDITING';
  
  // 编排模式数据
  plan?: {
    agents: Array<{
      id: string;
      name: string; // e.g., "David - Data Analyst"
      role: string;
      status: 'idle' | 'working' | 'completed';
      currentTask?: string;
    }>;
  };

  // 编辑模式数据
  project?: {
    fileTree: FileNode[]; // 递归文件树结构
    activeFileId: string | null;
    openFiles: string[]; // 支持多标签页
  };
  
  // 实时流式状态
  editorStream: {
    isStreaming: boolean;
    activeLine: number;
    contentBuffer: string; // 当前正在接收的增量内容
  };
}
```

### 3.2 组件结构 (Component Structure)
```
src/components/workspace/
├── WorkspacePanel.tsx       # 右侧面板容器，负责模式切换
├── orchestration/           # 编排模式组件
│   ├── OrchestrationView.tsx
│   ├── AgentSwimlane.tsx    # 代理泳道
│   └── TaskCard.tsx         # 任务卡片
└── editor/                  # 编辑模式组件
    ├── EditorView.tsx       # 编辑器容器
    ├── FileTreeSidebar.tsx  # 文件资源管理器 (递归)
    ├── TabBar.tsx           # 多标签页
    └── StreamingEditor.tsx  # 封装 Monaco/Sandpack，处理流式输入
```

## 4. 详细功能设计 (Detailed Design)

### 4.1 编排视图 (Orchestration View)
*   **复用现有逻辑**: 基于现有的 `AIStatusPanel` 进行重构，将其逻辑移入 `OrchestrationView`。
*   **布局优化**: 使用 CSS Grid 或 Flexbox 实现响应式的泳道布局。每个 Agent 占据一列或一行。
*   **状态同步**: 监听后端 `dispatch_subagent` 工具调用，实时更新 Agent 状态。

### 4.2 编辑视图 (Editor View)
*   **文件树**:
    *   实现一个递归组件 `FileTreeNode`，支持文件夹的展开/折叠。
    *   集成 `lucide-react` 图标库，根据文件类型显示不同图标。
*   **流式编辑器**:
    *   使用 `Sandpack` (或 `Monaco Editor`) 的只读实例作为基础。
    *   **Ghost Cursor 实现**: 创建一个绝对定位的 DOM 元素 (`div`)，根据当前输入的字符位置计算坐标 (需要简单的行列映射算法)。
    *   **增量更新**: 监听 LLM 的 `token` 流，实时追加到编辑器内容中，触发布局更新。

### 4.3 模式切换逻辑 (Mode Switching Logic)
*   **自动切换**:
    *   当 Agent 调用 `create_file`、`write_to_file` 或 `update_file` 时 -> 自动切换至 **EDITING** 模式，并打开目标文件。
    *   当 Agent 调用 `dispatch_subagent` 或开始 `planning` 阶段时 -> 自动切换至 **PLANNING** 模式。
*   **手动切换**: 用户可以通过顶部 Tab 手动在"执行流"和"代码预览"之间切换（保留现有交互，但增强内容）。

## 5. 接口定义 (API & Data)

### 5.1 文件操作
沿用 `src/lib/actions/files.ts` 中的 `getProjectFiles` 和 `getProjectFileContent` 接口。

### 5.2 实时事件
需要确保 WebSocket 或 轮询机制 (Polling) 能够携带足够的元数据（如 `current_file`, `cursor_position` 等），以便前端渲染幽灵光标。 *初期阶段可先通过简单的全量文本刷新 + 模拟打字机效果实现。*

## 6. 后续规划 (Roadmap)
*   **P0**: 完成左右分屏框架搭建，实现基础的模式切换。
*   **P0**: 实现文件树和基础代码编辑器。
*   **P1**: 实现编排视图的泳道图渲染。
*   **P1**: 实现编辑器中的"幽灵光标"和流式打字效果。
*   **P2**: 支持多标签页切换。
