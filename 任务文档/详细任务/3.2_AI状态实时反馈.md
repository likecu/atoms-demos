# 详细任务 3.2: AI 状态实时反馈 (AI Status Real-time Feedback)

## 1. 任务概述
在聊天界面的右侧面板中新增一个“AI 状态”（AI Status）页签，用于实时展示 AI 的思考过程、工具调用历史（执行命令、读写文件等）以及执行逻辑流。

## 2. 详细设计 (沉淀)

### 2.1 流程图渲染
- **技术选型**: `mermaid.js` 或自定义 SVG 渲染。
- **交互设计**: 支持点击节点查看该步骤的详细输出（如 Bash 的 stdout）。
- **截断策略**: 详细输出内容在前端展示时截断为 **1000 个字符**，以防 UI 卡顿。
- **展示范围**: 仅展示当前会话中 **最后一次请求** 的执行流程。
- **展示节点**:
    - **思考 (Thinking)**: AI 内部逻辑推理。
    - **工具调用 (Tool Call)**: `executeBash`, `readFile`, `writeFile`, `listFiles`。
    - **结果 (Tool Result)**: 操作执行结果。
    - **最终响应 (Final Answer)**: AI 生成的最终内容。

### 2.2 数据库 Schema: `ai_call_logs`
```sql
CREATE TABLE ai_call_logs (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    message_id UUID REFERENCES messages(id),
    project_id UUID REFERENCES projects(id),
    step_type TEXT NOT NULL, -- 'thinking', 'tool_call', 'tool_result', 'output'
    content TEXT,
    metadata JSONB, -- 存储工具名、参数、执行时间等
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

### 2.3 后端集成逻辑
在 `api/chat/route.ts` 中使用 `onStepFinish` 回调捕获步骤并持久化。

## 3. 开发任务分解 (Task Breakdown)

### 第一阶段: 数据模型与后端 Action
- [ ] **[DB]** 在 Supabase 中创建 `ai_call_logs` 表。
- [ ] **[Action]** 在 `lib/actions/message.ts` 中新增 `saveAICallLog` 函数。

### 第二阶段: 后端日志捕获
- [ ] **[API]** 修改 `src/app/api/chat/route.ts`，在 `generateText` 中配置 `onStepFinish` 钩子。
- [ ] **[API]** 实现将捕获的步骤实时存入数据库。

### 第三阶段: 前端 UI 与页签
- [ ] **[UI]** 在 `ChatPageClient` 的右侧面板新增 `AI 状态` 页签按钮。
- [ ] **[Hook]** 更新前端轮询逻辑，支持异步获取 `ai_call_logs` 数据。
- [ ] **[Component]** 实现 `AIStatusFlow` 组件，展示流程图节点。
- [ ] **[Interaction]** 实现点击节点弹出侧边 Drawer 或 Modal 展示截断后的详细日志 (1000字)。
- [ ] **[Logic]** 确保前端过滤逻辑只选取最新的 `message_id` 相关的 logs 进行展示。
- [ ] **[Style]** 使用 `framer-motion` 为节点添加实时进入动画。

## 4. 验收标准
- 用户切换到 "AI 状态" 页签能看到 AI 调用工具的实时列表。
- 每个步骤应显示图标（如 🧠 思考, 💻 终端, 📁 文件）。
- 流程图能够直观反映 AI 从规划到执行的完整链路。
